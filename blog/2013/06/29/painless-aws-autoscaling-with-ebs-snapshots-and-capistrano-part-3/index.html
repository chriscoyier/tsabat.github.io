
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Painless AWS Autoscaling With EBS Snapshots And Capistrano part 3 - Boom</title>
  <meta name="author" content="Timothy Sabat">

  
  <meta name="description" content="This is part two of a series designed to get your auto scaling environment running. If you&rsquo;re just tuning in, check out part 1 and part 2 In &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://tsabat.github.io/blog/2013/06/29/painless-aws-autoscaling-with-ebs-snapshots-and-capistrano-part-3">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Boom" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Boom</a></h1>
  
    <h2>Difficult takes a day, impossible takes a week.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:tsabat.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Painless AWS Autoscaling With EBS Snapshots and Capistrano Part 3</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-06-29T09:47:00-05:00" pubdate data-updated="true">Jun 29<span>th</span>, 2013</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>This is part two of a series designed to get your auto scaling environment running.  If you&rsquo;re just tuning in, check out <a href="/2013/06/29/painless-aws-autoscaling-with-ebs-snapshots-and-capistrano">part 1</a> and <a href="/2013/06/29/painless-aws-autoscaling-with-ebs-snapshots-and-capistrano-part-2">part 2</a></p>

<p>In the last part of this series, we reviewed a bunch of scripts used to deal with properly snapshotting and mounting volumes.  In this part we&rsquo;ll get our auto scaling system set up in aws.  Then we&rsquo;ll give a high-level run-through of what you need to do to complete your setup.  In this part we&rsquo;ll review these scripts:</p>

<ol>
<li><code>aws_create_lb.sh</code> &ndash; a bash script for creating an load balancer.</li>
<li><code>aws_create_launch_config.sh</code> &ndash; a bash script for creating launch configs.</li>
<li><code>aws_create_autoscaling_group.sh</code> &ndash; a bash script for creating an autoscaling group.</li>
<li><code>aws_create_scaling_policies.sh</code> &ndash; a bash script for creating policies and alarms.</li>
</ol>


<p>Finally, I&rsquo;ll tie together the whole process, referring to scripts as I go.</p>

<h3>Before you start</h3>

<p>The scripts that we&rsquo;re about to execute will work out of the box, but will have some very codepen-specific stuff listed in them.  You&rsquo;ll probably want to do your own naming of policies, lbs, etc.</p>

<p>Also, I&rsquo;m not going to go into great detail about the AWS creation scripts.  The most useful article I found on the topic is on the <a href="http://www.cardinalpath.com/autoscaling-your-website-with-amazon-web-services-part-2/">cardinal path</a> blog.  I followed his instructions until I understood the process well enough to build my own.</p>

<h2>AWS Autoscaling Creation Scripts</h2>

<p>I wrote bash scripts to automate the creation of my autoscaling setup.  Let&rsquo;s review each in turn below.</p>

<p><a href="https://gist.github.com/tsabat/5891540">aws_create_lb.sh</a> &ndash; It is pretty obvious what&rsquo;s happening in this script.  Be sure to change the <code>CERT_ID</code> variable and the <code>LB_NAME</code> to something that makes sense for you.</p>

<p><a href="https://gist.github.com/tsabat/5891427">aws_create_launch_config.sh</a> &ndash; Here we&rsquo;re building our launch config.  Be aware that the <code>USER_DATA_FILE</code> here is the one we created in <a href="/2013/06/29/painless-aws-autoscaling-with-ebs-snapshots-and-capistrano-part-2">part 2</a> of this walkthrough.  Find the source <a href="https://gist.github.com/tsabat/5891084">here</a>.</p>

<p><a href="https://gist.github.com/tsabat/5891536">aws_create_autoscaling_group</a> &ndash; Again, boilerplate stuff.</p>

<p><a href="https://gist.github.com/tsabat/5891535">aws_create_scaling_policies.sh</a> &ndash; Note that I&rsquo;m creating four things in this script:  two policies and two metric alarms.  To keep things DRY, I wrote a function and overrode the global variables twice, like so:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">echo</span> <span class="s2">&quot;scale up policy&quot;</span>
</span><span class='line'><span class="nv">POLICY_NAME</span><span class="o">=</span><span class="s2">&quot;scale-up&quot;</span>
</span><span class='line'><span class="nv">ADJUSTMENT</span><span class="o">=</span>1
</span><span class='line'><span class="nv">SCALE_UP</span><span class="o">=</span><span class="k">$(</span>add_policy<span class="k">)</span>
</span><span class='line'>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;scale down policy&quot;</span>
</span><span class='line'><span class="nv">POLICY_NAME</span><span class="o">=</span><span class="s2">&quot;scale-down&quot;</span>
</span><span class='line'><span class="nv">ADJUSTMENT</span><span class="o">=</span><span class="s2">&quot;-1&quot;</span>
</span><span class='line'><span class="nv">SCALE_DOWN</span><span class="o">=</span><span class="k">$(</span>add_policy<span class="k">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this case, <code>add_policy</code> is a function that we call twice.</p>

<h2>High Level Overview</h2>

<p>I&rsquo;ve thrown a lot of information at you all at once here and it&rsquo;s time to review the setup details from a high level.</p>

<ul>
<li>Create a new instance.  Install your webserver and get Capistrano pushing code.</li>
<li>Bootstrap your node with Chef, if you&rsquo;re using it</li>
<li>Create an AMI to work with</li>
<li>Launch a fresh AMI to work through your process</li>
<li>Manually set up your mount and volume for the first time, and snaphshot it, as described in <a href="/2013/06/29/painless-aws-autoscaling-with-ebs-snapshots-and-capistrano">part 1</a>.</li>
<li>Put <code>snapshot.py</code> and <code>prep_instance.py</code> onto your production AMI.</li>
<li>Add the <code>deploy:snapshot</code> task into your <code>deploy.rb</code>.</li>
<li>Put <code>utils.rb</code> into your <code>config</code> dir in your rails setup.</li>
<li>Add <code>production.rb</code> to your Capistrano multistage setup at <code>config/environments</code></li>
<li>Keep <code>chef_userdata.sh</code> and <code>userdata.sh</code> handy for when you work with <code>aws_create_launch_config.sh</code></li>
<li>Review the <code>autoscaling</code> recipe to see where all these files are stored on your production instance.</li>
</ul>


<h2>Conclusion</h2>

<p>Setting up an environment that scales based on load is cumbersome if you must constantly build AMIs every time your code changes.  The instructions listed in this series make Capistrano deployment a natural part of your autocaling process.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Timothy Sabat</span></span>

      








  


<time datetime="2013-06-29T09:47:00-05:00" pubdate data-updated="true">Jun 29<span>th</span>, 2013</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://tsabat.github.io/blog/2013/06/29/painless-aws-autoscaling-with-ebs-snapshots-and-capistrano-part-3/" data-via="timsabat" data-counturl="http://tsabat.github.io/blog/2013/06/29/painless-aws-autoscaling-with-ebs-snapshots-and-capistrano-part-3/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2013/06/29/painless-aws-autoscaling-with-ebs-snapshots-and-capistrano-part-2/" title="Previous Post: Painless AWS Autoscaling With EBS Snapshots And Capistrano Part 2">&laquo; Painless AWS Autoscaling With EBS Snapshots And Capistrano Part 2</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/06/29/painless-aws-autoscaling-with-ebs-snapshots-and-capistrano-part-3/">Painless AWS Autoscaling With EBS Snapshots And Capistrano part 3</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/06/29/painless-aws-autoscaling-with-ebs-snapshots-and-capistrano-part-2/">Painless AWS Autoscaling With EBS Snapshots And Capistrano Part 2</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/06/28/painless-aws-autoscaling-with-ebs-snapshots-and-capistrano/">Painless AWS Autoscaling With EBS Snapshots And Capistrano</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/05/09/build-and-deploy-a-resque-server-using-rbenv/">Build and Deploy a Resque Server Using rbenv</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/05/07/installing-a-rapidssl-ssl-cert-on-an-aws-load-balancer/">Installing a RapidSSL SSL cert on an AWS Load Balancer</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/tsabat">@tsabat</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'tsabat',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Timothy Sabat -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'boomboomboom';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://tsabat.github.io/blog/2013/06/29/painless-aws-autoscaling-with-ebs-snapshots-and-capistrano-part-3/';
        var disqus_url = 'http://tsabat.github.io/blog/2013/06/29/painless-aws-autoscaling-with-ebs-snapshots-and-capistrano-part-3/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
